version: 2.1

aliases:
  - &restore-yarn-cache
    name: Restore yarnpkg cache
    key: v5-yarn-cache

  - &restore-node-modules-cache
    name: Restore node_modules cache
    key: v5-yarn-deps-{{ checksum "yarn.lock" }}-{{ checksum "combined-package-lock.txt" }}

  - &save-yarn-cache
    name: Save yarnpkg cache
    paths:
      - .cache/yarn
    key: v5-yarn-cache

  - &save-node-modules-cache
    name: Save node_modules cache
    key: v5-node-modules
    paths:
      - node_modules

  - &persist-workspace
    root: "."
    paths:
      - ".git"
      - ".eslintrc.json"
      - ".prettierrc"
      - "jest.config.ts"
      - "package.json"
      - "tsconfig.json"
      - "yarn.lock"
      - "tmp/*"
      - "node_modules"

commands:
  databases:
    steps:
      - run: sudo apt-get update
      - run: sudo apt-get install postgresql-client-12

defaults: &defaults
  docker:
    - image: 'cimg/node:16.4.0'
    - image: 'cimg/postgres:12.9'
      auth:
        username: eduahcb
        password: $DOCKERHUB_PASSWORD
      environment:
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_PASSWORD: 123
        POSTGRES_USER: postgres
        POSTGRES_DB: api_jwt
        POSTGRES_HOST_AUTH_METHOD: fase
  working_directory: ~/workspace



jobs:
  build_packages:
    <<: *defaults
    
  
    steps:

      - checkout
      - restore_cache: *restore-node-modules-cache
      - restore_cache: *restore-yarn-cache

      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile --cache-folder .cache/yarn
      
      - save_cache: *save-node-modules-cache
      - save_cache: *save-yarn-cache
      - persist_to_workspace: *persist-workspace


  eslint:

    <<: *defaults

    steps:
      - attach_workspace:
          at: ~/workspace
          
      - checkout
      - run:
          name: Run Eslint
          command:  yarn eslint 
  tests:
    <<: *defaults

    steps:
      - checkout
      - databases

      - run:
          name: Waiting for Postgres to be ready
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      
      - attach_workspace:
          at: ~/workspace

      - run:
          name: run migrations
          command: yarn typeorm migration:run      

      - run:
          name: Run tests
          command: yarn test
workflows:
  ci:
    jobs:
      - build_packages
      - eslint:
          requires:
            - build_packages
      - tests:
          requires:
            - build_packages